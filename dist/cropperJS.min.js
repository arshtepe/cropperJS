"use strict";!function(){function t(){var t=void 0===arguments[0]?{}:arguments[0];s(t),this.params=t,this._htmlElements={},r(t.image)&&this.setImg(t.image),this._createElements(),this._setEvents()}function e(t,e){var i=["Webkit","Moz","ms","O",""];i.forEach(function(i){i+="UserSelect",t.style[i]=e})}function i(t,e){var i=document.createElement(t);return i.style.zIndex=e,i.style.position="absolute",i.style.top=0,i.style.left=0,i}function n(t,e){e.style.width=t.width+"px",e.style.height=t.height+"px",e.width=t.width,e.height=t.height}function s(t){!function e(t,i){for(var n in t)a(i[n])?i[n]=o(t[n])?Object.create(t[n]):t[n]:o(i[n])&&e(t[n],i[n])}(l,t)}function h(t){t.parentNode.removeChild(t)}function r(t){return"[object HTMLImageElement]"=={}.toString.call(t)}function a(t){return void 0===t||null===t||t!=t}function o(t){return"[object Object]"=={}.toString.call(t)}var l={transparency:.7,autoSelect:!1,maxCanvasSize:{width:650,height:400},cropZone:{border:{type:"dashed",opacity:.7,lineDashes:[10,10],width:2,color:"gray"},point:{color:"gray",opacity:1,count:6,width:10,height:10}},select:{minWidth:0,minHeight:0}};t.prototype.getCropperElement=function(){return this._htmlElements.container},t.prototype.setImg=function(t){var e=this,i=this.params;if(!r(t))throw new TypeError("Wrong argument [img]");if(a(this._image)||t!=this._image&&t.src!=this._image.src){if(!t.complete){var s=function(){var i=void 0;return t.addEventListener("load",i=function(){e.setImg(t),t.removeEventListener("load",i)}),{v:e}}();if("object"==typeof s)return s.v}this._image=t;var h=this._size=this._getSize(t),o=this._htmlElements.canvasImgBg,l=o.getContext("2d"),c=(h.width-i.select.minWidth)/2,m=(h.height-i.select.minHeight)/2;return n(h,this._htmlElements.canvasOverlay),n(h,o),n(h,this._htmlElements.container),this.clearOverlay(),l.translate(h.width-1,h.height-1),l.rotate(Math.PI),l.clearRect(0,0,h.width,h.height),l.drawImage(t,0,0,h.width,h.height),i.autoSelect&&this.setSelectZone(c,m),this}},t.prototype.setSelectZone=function(t,e,i,n){var s=this.params.select;i=i||s.minWidth,n=n||s.minHeight,i=Math.max(i,s.minWidth),n=Math.max(n,s.minHeight),a(s.maxHeight)||(n=Math.min(n,s.maxHeight)),a(s.maxWidth)||(i=Math.min(i,s.maxWidth)),this._setSelectZone(t,e,i,n)},t.prototype._setSelectZone=function(t,e,i,n){if(a(t)||a(e))throw new TypeError("Wrong argument [ x ] or [ y ]");a(this._image)||(t=Math.max(t,0),e=Math.max(e,0),t+i>this._size.width&&(i=this._size.width-t),e+n>this._size.height&&(n=this._size.height-e),this.clearOverlay(),this._renderOverlay(),this._renderSelectZone(t,e,i,n),this._select={x:t,y:e,width:i,height:n})},t.prototype.getImageUrl=function(){if(!a(this._select)&&!a(this._image)){var t=this._select,e=document.createElement("canvas"),i=this._htmlElements.canvasImgBg.getContext("2d"),n=i.getImageData(t.x,t.y,t.width,t.height),s=e.getContext("2d");return e.width=t.width,e.height=t.height,s.putImageData(n,0,0),e.toDataURL()}},t.prototype.getSelectImage=function(){if(!a(this._select)&&!a(this._image)){var t=new Image;return t.src=this.getImageUrl(),t}},t.prototype.getSelectSize=function(){return this._select},t.prototype.clearOverlay=function(){a(this._image)||(this._ctxOverlay.clearRect(0,0,this._size.width,this._size.height),this._select=null)},t.prototype.destroy=function(){if(!this._isDestroyed){window.removeEventListener("mouseup",this._windowEndHandler),Object.keys(this._htmlElements).forEach(function(t){this._htmlElements[t]=h(this._htmlElements[t])},this);for(var t in this)delete this[t];this._isDestroyed=!0}},t.prototype._renderOverlay=function(){var t=this._ctxOverlay;t.globalAlpha=this.params.transparency,t.fillStyle="#000",t.fillRect(0,0,this._size.width,this._size.height)},t.prototype._renderSelectZone=function(t,e,i,n){var s=this._ctxOverlay,h=this.params.cropZone;s.clearRect(t,e,i,n),"dashed"==h.border.type&&(a(s.setLineDash)?a(s.mozDasz)&&s.mozDash(h.border.lineDashes):s.setLineDash(h.border.lineDashes)),s.beginPath(),s.globalAlpha=h.border.transparency,s.lineWidth=h.border.width,s.strokeStyle=h.border.color,s.rect(t,e,i,n),s.stroke()},t.prototype._createElements=function(){var t,e,n=document.createElement("div");t=this._htmlElements.canvasImgBg=i("canvas",0),e=this._htmlElements.canvasOverlay=i("canvas",10),this._ctxOverlay=e.getContext("2d"),n.appendChild(t),n.appendChild(e),n.style.width=0,n.style.height=0,n.style.position="relative",this._htmlElements.container=n},t.prototype._getSize=function(t){var e=1,i=1,n=1,s=t.width,h=t.height,r=this.params.maxCanvasSize.width,a=this.params.maxCanvasSize.height;return s>r&&(i=r/s),h>a&&(n=a/h),e=Math.min(i,n),{width:s*e,height:h*e,scale:e}},t.prototype._setEvents=function(){function t(t){a(r._image)||r._select&&i(t)||(r._select=null,r._selectingStart={x:t.clientX,y:t.clientY},e(document.body,"none"),window.addEventListener("mousemove",s))}function i(t){var e=o.getBoundingClientRect(),i=r._select,n=t.clientX-e.left,s=t.clientY-e.top,a=r.params.cropZone.border.width,l=i.x+i.width+a,c=i.y+i.height+a;return n>=i.x-a&&l>=n&&s>=i.y-a&&c>=s?(r._dragingStart={x:t.clientX,y:t.clientY,cursorX:t.clientX-e.left-i.x,cursorY:t.clientY-e.top-i.y},window.addEventListener("mousemove",h),!0):!1}function n(){a(r._select)&&!a(r._image)&&r.clearOverlay()}function s(t){var e=r._selectingStart,i=r._htmlElements.container.getBoundingClientRect(),n=e.x-i.left,s=e.y-i.top,h=t.clientX-i.left,a=t.clientY-i.top,o=h-n,l=a-s,c=0>o?o:0,m=0>l?l:0;o=Math.abs(o),l=Math.abs(l),0>=h&&(o=n),0>=a&&(l=s),r._setSelectZone(n+c,s+m,o,l)}function h(t){var e=r._dragingStart,i=r._htmlElements.container.getBoundingClientRect(),n=e.x-t.clientX,s=e.y-t.clientY,h=e.x-i.left-n-e.cursorX,a=e.y-i.top-s-e.cursorY;h+r._select.width>i.width&&(h=i.width-r._select.width),a+r._select.height>i.height&&(a=i.height-r._select.height),r._setSelectZone(h,a,r._select.width,r._select.height)}var r=this,o=this._htmlElements.canvasOverlay;this._windowEndHandler=function(){var t=r._select;window.removeEventListener("mousemove",s),window.removeEventListener("mousemove",h),e(document.body,""),a(t)||r.setSelectZone(t.x,t.y,t.width,t.height)},o.addEventListener("click",n),o.addEventListener("mousedown",t),window.addEventListener("mouseup",this._windowEndHandler)},window.CropperJS=t}();